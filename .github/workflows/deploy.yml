name: Deploy

on:
  push:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:        
  checkout:
    strategy:
      fail-fast: false
      matrix: 
        ct: [ "cf-ddns", "caddy", "syncthing", "minecraft" ]
    runs-on:
      - self-hosted
      - ${{ matrix.ct }}
    steps:
      - name: ‚è¨ Checkout
        uses: actions/checkout@v4
      
  deploy-cloudflare-ddns:
    runs-on:
      - self-hosted
      - cf-ddns
    needs:
      - checkout
    steps:
      - name: üìù Copy config
        working-directory: Cloudflare-DDNS
        run: sudo cp configuration.nix /etc/nixos/configuration.nix

      - name: ‚öôÔ∏è Apply config
        run: sudo nixos-rebuild switch

  # deploy-caddy:
  #   runs-on:
  #     - self-hosted
  #     - caddy
  #   needs:
  #     - checkout
  #     - deploy-cloudflare-ddns
  #   steps:
  #     - name: Deploy - Caddy
  #       working-directory: Caddy
  #       run: |
  #         docker compose build --pull
  #         docker compose up --detach --remove-orphans

  # deploy-syncthing:
  #   runs-on:
  #     - self-hosted
  #     - syncthing
  #   needs:
  #     - checkout
  #     - deploy-cloudflare-ddns
  #     - deploy-caddy
  #   steps:
  #     - name: Deploy - SyncThing
  #       working-directory: SyncThing
  #       run: |
  #         docker compose pull
  #         docker compose up --detach --remove-orphans

  # deploy-minecraft:
  #   runs-on:
  #     - self-hosted
  #     - minecraft
  #   needs:
  #     - checkout
  #     - deploy-cloudflare-ddns
  #     - deploy-caddy
  #   steps:
  #     - name: Deploy - Minecraft
  #       working-directory: Minecraft
  #       run: |
  #         docker compose build --pull
  #         docker compose up --detach --remove-orphans
