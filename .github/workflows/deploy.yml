name: Deploy

on:
  push:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:        
  deploy:
    runs-on:
      - self-hosted
      - morph
    steps:
      - name: ‚è¨ Checkout
        uses: actions/checkout@v4

      - name: üìù Restore SSH Config
        working-directory: morph
        run: |
          mkdir -p ~/.ssh/
          cp ssh-config ~/.ssh/config

      - name: ‚è´ Morph deploy
        working-directory: morph
        env:
          SSH_USER: root
          SSH_IDENTITY_FILE: $HOME/.ssh/id_rsa
          SSH_SKIP_HOST_KEY_CHECK: true
          SSH_CONFIG_FILE: $HOME/.ssh/config
        run: nix-shell --packages morph --command 'morph deploy simple.nix switch'

  # deploy-caddy:
  #   runs-on:
  #     - self-hosted
  #     - caddy
  #   needs:
  #     - checkout
  #     - deploy-cloudflare-ddns
  #   steps:
  #     - name: Deploy - Caddy
  #       working-directory: Caddy
  #       run: |
  #         docker compose build --pull
  #         docker compose up --detach --remove-orphans

  # deploy-syncthing:
  #   runs-on:
  #     - self-hosted
  #     - syncthing
  #   needs:
  #     - checkout
  #     - deploy-cloudflare-ddns
  #     - deploy-caddy
  #   steps:
  #     - name: Deploy - SyncThing
  #       working-directory: SyncThing
  #       run: |
  #         docker compose pull
  #         docker compose up --detach --remove-orphans

  # deploy-minecraft:
  #   runs-on:
  #     - self-hosted
  #     - minecraft
  #   needs:
  #     - checkout
  #     - deploy-cloudflare-ddns
  #     - deploy-caddy
  #   steps:
  #     - name: Deploy - Minecraft
  #       working-directory: Minecraft
  #       run: |
  #         docker compose build --pull
  #         docker compose up --detach --remove-orphans
