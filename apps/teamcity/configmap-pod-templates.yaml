apiVersion: v1
kind: ConfigMap
metadata:
  name: teamcity-pod-templates
  namespace: teamcity
data:
  agent-pod-spec: |
    # --- Start of Pod Template ---
    apiVersion: v1
    kind: Pod
    metadata:
      # TeamCity will automatically append a unique ID to this name (e.g., teamcity-agent-xxxx)
      generateName: teamcity-agent-
      labels:
        app: teamcity-agent
        pool: k8s-builder-pool
    spec:
      # CRITICAL: This links the Pod to the ServiceAccount you created in the RBAC steps.
      serviceAccountName: teamcity-sa
      
      # Define the single container that will run the build agent
      containers:
      - name: teamcity-agent
        # Replace this with the specific image you want to use for your builds
        image: jetbrains/teamcity-agent:latest 
        
        # Resource requests ensure the Pod is scheduled efficiently.
        # Limits prevent the Pod from consuming excessive node resources.
        resources:
          limits:
            cpu: "1000m" # 1 full CPU core max
            memory: "2Gi" # 2 Gigabytes of RAM max
          requests:
            cpu: "500m"  # Request half a CPU core
            memory: "1Gi" # Request 1 Gigabyte of RAM
            
        # Optional: Add environment variables needed for your specific builds
        env:
          - name: AGENT_CUSTOM_PROPERTY # Example custom property for agent requirements
            value: "k8s-enabled"

      # The agent is designed to run one job and then be terminated.
      restartPolicy: Never 
